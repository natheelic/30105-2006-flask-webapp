{% extends "base.html" %}

{% block title %}Add Device{% endblock %}

{% block content %}
<div class="container">
    <div class="form-header">
        <h1><i class="fas fa-plus-circle"></i> Add New Device</h1>
        <p class="lead">เพิ่ม ESP32 หรือ Raspberry Pi Pico WH device ใหม่</p>
    </div>

    <div class="form-container">
        <form method="POST" class="device-form">
            <div class="form-sections">
                <!-- Basic Information -->
                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Basic Information</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="device_name" class="form-label">Device Name *</label>
                            <input type="text" 
                                   id="device_name" 
                                   name="device_name" 
                                   class="form-control" 
                                   placeholder="e.g., Garden_Sensor_01"
                                   required>
                            <small class="form-text">ชื่อเฉพาะสำหรับอุปกรณ์นี้</small>
                        </div>

                        <div class="form-group">
                            <label for="device_type" class="form-label">Device Type *</label>
                            <select id="device_type" name="device_type" class="form-control" required>
                                <option value="ESP32">ESP32</option>
                                <option value="PICO_WH">Raspberry Pi Pico WH</option>
                                <option value="ESP8266">ESP8266</option>
                            </select>
                            <small class="form-text">เลือกประเภทของอุปกรณ์</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description" class="form-label">Description</label>
                        <textarea id="description" 
                                  name="description" 
                                  class="form-control" 
                                  rows="3"
                                  placeholder="Describe what this device will be used for..."></textarea>
                    </div>
                </div>

                <!-- WiFi Configuration -->
                <div class="form-section">
                    <h3><i class="fas fa-wifi"></i> WiFi Configuration</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="wifi_ssid" class="form-label">WiFi SSID</label>
                            <input type="text" 
                                   id="wifi_ssid" 
                                   name="wifi_ssid" 
                                   class="form-control" 
                                   placeholder="Your WiFi Network Name">
                            <small class="form-text">ชื่อเครือข่าย WiFi ที่อุปกรณ์จะเชื่อมต่อ</small>
                        </div>

                        <div class="form-group">
                            <label for="wifi_password" class="form-label">WiFi Password</label>
                            <input type="password" 
                                   id="wifi_password" 
                                   name="wifi_password" 
                                   class="form-control" 
                                   placeholder="Your WiFi Password">
                            <small class="form-text">รหัสผ่าน WiFi</small>
                        </div>
                    </div>
                </div>

                <!-- Pin Configuration -->
                <div class="form-section">
                    <h3><i class="fas fa-microchip"></i> Pin Configuration</h3>
                    
                    <div class="pin-grid">
                        <div class="form-group">
                            <label for="temp_pin" class="form-label">
                                <i class="fas fa-thermometer-half"></i> Temperature Sensor Pin
                            </label>
                            <select id="temp_pin" name="temp_pin" class="form-control">
                                <option value="4" selected>GPIO 4</option>
                                <option value="2">GPIO 2</option>
                                <option value="5">GPIO 5</option>
                                <option value="18">GPIO 18</option>
                                <option value="19">GPIO 19</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="light_pin" class="form-label">
                                <i class="fas fa-sun"></i> Light Sensor Pin (ADC)
                            </label>
                            <select id="light_pin" name="light_pin" class="form-control">
                                <option value="32" selected>GPIO 32 (ADC1_CH4)</option>
                                <option value="33">GPIO 33 (ADC1_CH5)</option>
                                <option value="34">GPIO 34 (ADC1_CH6)</option>
                                <option value="35">GPIO 35 (ADC1_CH7)</option>
                                <option value="36">GPIO 36 (ADC1_CH0)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="led_pin" class="form-label">
                                <i class="fas fa-lightbulb"></i> Status LED Pin
                            </label>
                            <select id="led_pin" name="led_pin" class="form-control">
                                <option value="2" selected>GPIO 2 (Built-in LED)</option>
                                <option value="5">GPIO 5</option>
                                <option value="18">GPIO 18</option>
                                <option value="19">GPIO 19</option>
                                <option value="21">GPIO 21</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="relay_pin" class="form-label">
                                <i class="fas fa-toggle-on"></i> Relay Control Pin
                            </label>
                            <select id="relay_pin" name="relay_pin" class="form-control">
                                <option value="5" selected>GPIO 5</option>
                                <option value="18">GPIO 18</option>
                                <option value="19">GPIO 19</option>
                                <option value="21">GPIO 21</option>
                                <option value="22">GPIO 22</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Sensor Configuration -->
                <div class="form-section">
                    <h3><i class="fas fa-sliders-h"></i> Sensor Configuration</h3>
                    
                    <div class="sensor-grid">
                        <div class="form-check">
                            <input type="checkbox" 
                                   id="temp_enabled" 
                                   name="temp_enabled" 
                                   class="form-check-input" 
                                   checked>
                            <label for="temp_enabled" class="form-check-label">
                                <i class="fas fa-thermometer-half text-danger"></i>
                                Temperature Sensor (DHT22)
                            </label>
                        </div>

                        <div class="form-check">
                            <input type="checkbox" 
                                   id="humidity_enabled" 
                                   name="humidity_enabled" 
                                   class="form-check-input" 
                                   checked>
                            <label for="humidity_enabled" class="form-check-label">
                                <i class="fas fa-tint text-primary"></i>
                                Humidity Sensor (DHT22)
                            </label>
                        </div>

                        <div class="form-check">
                            <input type="checkbox" 
                                   id="light_enabled" 
                                   name="light_enabled" 
                                   class="form-check-input" 
                                   checked>
                            <label for="light_enabled" class="form-check-label">
                                <i class="fas fa-sun text-warning"></i>
                                Light Sensor (LDR/Photodiode)
                            </label>
                        </div>

                        <div class="form-check">
                            <input type="checkbox" 
                                   id="soil_enabled" 
                                   name="soil_enabled" 
                                   class="form-check-input">
                            <label for="soil_enabled" class="form-check-label">
                                <i class="fas fa-seedling text-success"></i>
                                Soil Moisture Sensor
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Program Template -->
                <div class="form-section">
                    <h3><i class="fas fa-code"></i> Program Template</h3>
                    
                    <div class="form-group">
                        <label for="program_template" class="form-label">Select Template</label>
                        <select id="program_template" name="program_template" class="form-control">
                            <option value="basic_sensor" selected>Basic Sensor Reading</option>
                            <option value="advanced_iot">Advanced IoT with Deep Sleep</option>
                            <option value="relay_control">Relay Control System</option>
                        </select>
                        <small class="form-text">เลือก template โปรแกรมที่เหมาะกับการใช้งาน</small>
                    </div>
                    
                    <div class="template-preview">
                        <h4>Template Features:</h4>
                        <div id="template-features">
                            <div class="feature basic_sensor">
                                <i class="fas fa-check text-success"></i>
                                WiFi connectivity & automatic reconnection
                            </div>
                            <div class="feature basic_sensor">
                                <i class="fas fa-check text-success"></i>
                                Sensor data reading (DHT22, Light, Soil)
                            </div>
                            <div class="feature basic_sensor">
                                <i class="fas fa-check text-success"></i>
                                HTTP POST to server every 30 seconds
                            </div>
                            <div class="feature basic_sensor">
                                <i class="fas fa-check text-success"></i>
                                LED status indicators
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <a href="{{ url_for('device_management') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Devices
                </a>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Create Device
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.form-header {
    text-align: center;
    margin-bottom: 3rem;
    padding: 2rem 0;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border-radius: 10px;
}

.form-header h1 {
    margin: 0;
    font-size: 2.5rem;
}

.form-header .lead {
    margin: 1rem 0 0 0;
    font-size: 1.2rem;
    opacity: 0.9;
}

.form-container {
    max-width: 1000px;
    margin: 0 auto;
}

.device-form {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.form-sections {
    margin-bottom: 2rem;
}

.form-section {
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 2px solid #f8f9fa;
}

.form-section:last-child {
    border-bottom: none;
}

.form-section h3 {
    color: #333;
    margin-bottom: 1.5rem;
    font-size: 1.3rem;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.pin-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.sensor-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
}

.form-control {
    width: 100%;
    padding: 0.8rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: #28a745;
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
}

.form-text {
    display: block;
    margin-top: 0.5rem;
    color: #666;
    font-size: 0.85rem;
}

.form-check {
    display: flex;
    align-items: center;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
}

.form-check:hover {
    background-color: #e9ecef;
}

.form-check-input {
    width: 20px;
    height: 20px;
    margin-right: 1rem;
    cursor: pointer;
}

.form-check-label {
    cursor: pointer;
    margin: 0;
    font-weight: 500;
}

.template-preview {
    margin-top: 1rem;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 8px;
}

.template-preview h4 {
    margin-bottom: 1rem;
    color: #333;
}

.feature {
    padding: 0.5rem 0;
    color: #555;
}

.form-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 2rem;
    border-top: 2px solid #f8f9fa;
}

.btn {
    padding: 0.8rem 2rem;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
    border: none;
}

.btn-secondary:hover {
    background-color: #545b62;
    transform: translateY(-2px);
}

.btn-success {
    background-color: #28a745;
    color: white;
    border: none;
}

.btn-success:hover {
    background-color: #1e7e34;
    transform: translateY(-2px);
}

@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .pin-grid {
        grid-template-columns: 1fr;
    }
    
    .sensor-grid {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
        gap: 1rem;
    }
    
    .form-header h1 {
        font-size: 2rem;
    }
}

/* Dynamic template features */
.feature.advanced_iot,
.feature.relay_control {
    display: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Template preview functionality
    const templateSelect = document.getElementById('program_template');
    const features = document.querySelectorAll('.feature');
    
    const templateFeatures = {
        basic_sensor: [
            'WiFi connectivity & automatic reconnection',
            'Sensor data reading (DHT22, Light, Soil)',
            'HTTP POST to server every 30 seconds',
            'LED status indicators',
            'Error handling and retry logic'
        ],
        advanced_iot: [
            'All basic sensor features',
            'Deep sleep mode for power saving',
            'OTA (Over-The-Air) updates',
            'Remote command execution',
            'Advanced error recovery',
            'System statistics monitoring'
        ],
        relay_control: [
            'Basic sensor features',
            'Relay control via web interface',
            'Web-based control panel',
            'Scheduled relay operations',
            'Manual and automatic control modes'
        ]
    };
    
    function updateTemplateFeatures() {
        const selectedTemplate = templateSelect.value;
        const featuresContainer = document.getElementById('template-features');
        
        featuresContainer.innerHTML = '';
        
        templateFeatures[selectedTemplate].forEach(feature => {
            const featureElement = document.createElement('div');
            featureElement.className = 'feature';
            featureElement.innerHTML = `
                <i class="fas fa-check text-success"></i>
                ${feature}
            `;
            featuresContainer.appendChild(featureElement);
        });
    }
    
    templateSelect.addEventListener('change', updateTemplateFeatures);
    
    // Device type specific pin updates
    const deviceTypeSelect = document.getElementById('device_type');
    const lightPinSelect = document.getElementById('light_pin');
    
    deviceTypeSelect.addEventListener('change', function() {
        const deviceType = this.value;
        
        if (deviceType === 'PICO_WH') {
            // Update pins for Pico WH
            lightPinSelect.innerHTML = `
                <option value="26" selected>GPIO 26 (ADC0)</option>
                <option value="27">GPIO 27 (ADC1)</option>
                <option value="28">GPIO 28 (ADC2)</option>
            `;
        } else {
            // ESP32 pins
            lightPinSelect.innerHTML = `
                <option value="32" selected>GPIO 32 (ADC1_CH4)</option>
                <option value="33">GPIO 33 (ADC1_CH5)</option>
                <option value="34">GPIO 34 (ADC1_CH6)</option>
                <option value="35">GPIO 35 (ADC1_CH7)</option>
                <option value="36">GPIO 36 (ADC1_CH0)</option>
            `;
        }
    });
    
    // Form validation
    const form = document.querySelector('.device-form');
    form.addEventListener('submit', function(e) {
        const deviceName = document.getElementById('device_name').value.trim();
        
        if (!deviceName) {
            e.preventDefault();
            alert('กรุณาใส่ชื่ออุปกรณ์');
            return;
        }
        
        if (deviceName.includes(' ')) {
            e.preventDefault();
            alert('ชื่ออุปกรณ์ไม่ควรมีช่องว่าง กรุณาใช้ _ แทน เช่น Garden_Sensor_01');
            return;
        }
    });
});
</script>
{% endblock %}
